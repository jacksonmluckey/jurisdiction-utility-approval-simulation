---
title: "Polycentric City Visualization Example"
format:
    html:
        embed-resources: true

---

This notebook demonstrates how to generate and visualize polycentric city density patterns using the City class.

## Setup

```{python}
import sys
sys.path.append('..')

from city import City, CityConfig
from city import PolycentricConfig, TransportationConfig, CorridorType
```

## City Class Examples

The `City` class provides a unified interface for creating cities with all configuration in one place. Here are several examples demonstrating different city types.

### Example 1: Basic City with Polycentric Density

```{python}
print("=" * 70)
print("EXAMPLE 1: Basic City with Polycentric Density")
print("=" * 70)

# Configure city parameters
city_config = CityConfig(
    width=50,
    height=50,
    block_size_meters=100.0,
    block_area_acres=2.47,  # ~100m x 100m
    max_density_units_per_acre=50.0,
    min_density_units_per_acre=1.0,
    persons_per_unit=2.5
)

# Configure polycentric density
polycentric_config = PolycentricConfig(
    num_centers=3,
    center_distribution="uniform",
    primary_density=25.0,
    density_decay_rate=0.15
)

# Create and generate city
city = City(
    config=city_config,
    polycentric_config=polycentric_config
)
grid = city.generate()

# Show summary
city.summary()

# Access properties
print(f"\nCity Properties:")
print(f"  Total population: {city.total_population:,.0f}")
print(f"  Total units: {city.total_units:,}")
print(f"  Total area: {city.total_area_acres:,.1f} acres")
print(f"  Average density: {city.average_density:.2f} units/acre")
```

### Example 2: City with Transportation Corridors

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 2: City with Transportation Corridors")
print("=" * 70)

# Configure transportation
transport_config = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.20,
    connect_all_centers=True
)

# Create city with transportation
city_with_transport = City(
    config=city_config,
    polycentric_config=polycentric_config,
    transport_configs=[transport_config]
)
grid_transport = city_with_transport.generate()

city_with_transport.summary()
```

### Example 3: High-Density City with Radial Corridors

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 3: High-Density City with Radial Corridors")
print("=" * 70)

# High-density configuration
high_density_config = CityConfig(
    width=40,
    height=40,
    block_area_acres=2.47,
    max_density_units_per_acre=80.0,
    persons_per_unit=2.2  # Smaller household size in high-density areas
)

# More centers, higher density
high_density_polycentric = PolycentricConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density=35.0,
    density_decay_rate=0.10
)

# Radial corridors
radial_transport = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.25,
    radial_corridors_count=6,
    include_ring_roads=True,
    ring_road_radius_blocks=10
)

city_high_density = City(
    config=high_density_config,
    polycentric_config=high_density_polycentric,
    transport_configs=[radial_transport]
)
city_high_density.generate()
city_high_density.summary()
```

### Example 4: City with Multiple Transportation Corridors

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 4: City with Multiple Transportation Corridors")
print("=" * 70)

# Configure multiple transportation corridor types
# 1. Wide highways connecting centers
highways = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=3,
    density_multiplier=1.10,
    connect_all_centers=True
)

# 2. Narrow transit grid
transit_grid = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.25
)

# 3. Radial corridors from center
radial = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.15,
    radial_corridors_count=6
)

# Create city with all three corridor types
city_multi = City(
    config=city_config,
    polycentric_config=polycentric_config,
    transport_configs=[highways, transit_grid, radial]
)
city_multi.generate()
city_multi.summary()

print("\n" + "=" * 70)
print("All examples completed successfully!")
print("=" * 70)
```

### Example 5: City with Density Noise

Add realistic variability to housing units using proportional noise:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 5: City with Density Noise")
print("=" * 70)

import numpy as np

# Configure city with proportional noise
# units_noise=0.15 means 15% std dev relative to base units
city_config_noise = CityConfig(
    width=50,
    height=50,
    block_area_acres=2.47,
    max_density_units_per_acre=50.0,
    persons_per_unit=2.5,
    units_noise=0.15,  # 15% proportional noise
    random_seed=42  # For reproducibility
)

polycentric_config = PolycentricConfig(
    num_centers=3,
    center_distribution="uniform",
    primary_density=25.0,
    density_decay_rate=0.15
)

city_noise = City(
    config=city_config_noise,
    polycentric_config=polycentric_config
)
city_noise.generate()
city_noise.summary()

# Show some example blocks to see variation
print("\nSample blocks showing noise effect:")
sample_blocks = [city_noise.grid.blocks[i] for i in [100, 500, 1000, 1500, 2000]]
for block in sample_blocks:
    print(f"  Block ({block.x}, {block.y}): {block.units} units, {block.population:.1f} people")

# Visualize to see spatial noise pattern
city_noise.visualize()
```

### Example 6: City with Custom Noise Function

Use a custom function to control noise based on density:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 6: City with Custom Noise Function")
print("=" * 70)

def heteroskedastic_noise(base_units):
    """
    Higher absolute variability in denser areas, but lower relative variability.
    Sparse areas: high relative variability (±50%)
    Dense areas: low relative variability (±10%)
    """
    if base_units < 20:
        # Sparse: high proportional noise
        std_dev = base_units * 0.5
    elif base_units < 50:
        # Medium density: moderate noise
        std_dev = base_units * 0.25
    else:
        # High density: lower proportional noise but higher absolute
        std_dev = base_units * 0.1

    return np.random.normal(0, std_dev)

city_config_custom_noise = CityConfig(
    width=50,
    height=50,
    block_area_acres=2.47,
    max_density_units_per_acre=60.0,
    persons_per_unit=2.5,
    units_noise=heteroskedastic_noise,
    random_seed=42
)

city_custom_noise = City(
    config=city_config_custom_noise,
    polycentric_config=polycentric_config
)
city_custom_noise.generate()
city_custom_noise.summary()

# Visualize heteroskedastic noise pattern
city_custom_noise.visualize()
```

### Example 7: City with Dynamic Household Size

Use a function to vary household size based on housing density:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 7: City with Dynamic Household Size")
print("=" * 70)

def density_based_household_size(units, noise):
    """
    Household size decreases with higher density:
    - Sparse areas (< 20 units): Suburban families, avg 3.0 persons
    - Medium areas (20-50 units): Mixed housing, avg 2.3 persons
    - Dense areas (> 50 units): Apartments, avg 1.8 persons
    """
    if units < 20:
        return 3.0  # Suburban single-family homes
    elif units < 50:
        return 2.3  # Urban mixed housing
    else:
        return 1.8  # High-density apartments

city_config_dynamic = CityConfig(
    width=50,
    height=50,
    block_area_acres=2.47,
    max_density_units_per_acre=80.0,
    persons_per_unit=density_based_household_size,  # Function instead of float
    random_seed=42
)

polycentric_dense = PolycentricConfig(
    num_centers=4,
    center_distribution="uniform",
    primary_density=35.0,
    density_decay_rate=0.12
)

city_dynamic = City(
    config=city_config_dynamic,
    polycentric_config=polycentric_dense
)
city_dynamic.generate()
city_dynamic.summary()

# Show how household size varies with density
print("\nHousehold size variation by density:")
low_density_blocks = [b for b in city_dynamic.grid.blocks if b.units < 20]
med_density_blocks = [b for b in city_dynamic.grid.blocks if 20 <= b.units < 50]
high_density_blocks = [b for b in city_dynamic.grid.blocks if b.units >= 50]

if low_density_blocks:
    avg_household_low = np.mean([b.population / b.units for b in low_density_blocks if b.units > 0])
    print(f"  Low density (< 20 units): {avg_household_low:.2f} persons/unit")
if med_density_blocks:
    avg_household_med = np.mean([b.population / b.units for b in med_density_blocks if b.units > 0])
    print(f"  Medium density (20-50 units): {avg_household_med:.2f} persons/unit")
if high_density_blocks:
    avg_household_high = np.mean([b.population / b.units for b in high_density_blocks if b.units > 0])
    print(f"  High density (> 50 units): {avg_household_high:.2f} persons/unit")

# Visualize the city with variable household sizes
city_dynamic.visualize()
```

### Example 8: Combining Noise and Dynamic Household Size

Combine both features for maximum realism:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 8: Combining Noise and Dynamic Household Size")
print("=" * 70)

def adaptive_household_size(units, noise):
    """
    Household size based on density, with noise awareness.
    In high-variability blocks, household composition may be more diverse.
    """
    # Base household size by density
    if units < 25:
        base_size = 2.8
    elif units < 60:
        base_size = 2.2
    else:
        base_size = 1.9

    # Adjust slightly for high-variance blocks (more mixed housing types)
    if noise is not None and abs(noise) > 15:
        base_size += 0.1  # Slightly higher diversity in high-variance blocks

    return base_size

city_config_combined = CityConfig(
    width=60,
    height=60,
    block_area_acres=2.47,
    max_density_units_per_acre=70.0,
    units_noise=0.12,  # 12% proportional noise
    persons_per_unit=adaptive_household_size,
    random_seed=42
)

polycentric_realistic = PolycentricConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density=30.0,
    density_decay_rate=0.10
)

# Add transportation for added realism
transit_corridors = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.18
)

city_combined = City(
    config=city_config_combined,
    polycentric_config=polycentric_realistic,
    transport_configs=[transit_corridors]
)
city_combined.generate()
city_combined.summary()

# Analyze the combined effect
print("\nCombined effects analysis:")
print(f"  Population range: {min(b.population for b in city_combined.grid.blocks):.0f} - "
      f"{max(b.population for b in city_combined.grid.blocks):.0f} people/block")
print(f"  Units range: {min(b.units for b in city_combined.grid.blocks)} - "
      f"{max(b.units for b in city_combined.grid.blocks)} units/block")

# Calculate coefficient of variation for units (shows noise effect)
units_list = [b.units for b in city_combined.grid.blocks]
cv_units = np.std(units_list) / np.mean(units_list)
print(f"  Coefficient of variation (units): {cv_units:.3f}")

# Visualize the complete realistic city
city_combined.visualize()
```

---

## Alternative: Using Individual Components

You can also use `PolycentricCity` directly for more granular control:

### Setup (Alternative)

```{python}
from city import PolycentricCity, PolycentricConfig
from city import visualize_grid, visualize_population, visualize_units, print_grid_summary
from city import visualize_with_corridors
```

## Generate a Polycentric City

Create a city with 3 centers distributed uniformly:

```{python}
# Configure the city
config = PolycentricConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density=18.0,
    density_decay_rate=0.1,
    center_strength_decay=0.6,
    persons_per_unit=2.5
)

# Generate the city
city = PolycentricCity(grid_rows=100, grid_cols=100, config=config)
grid = city.generate()

# Show summary
city.visualize_summary()
```

## Visualize the City

### Combined View (Population + Units)

```{python}
#| fig-width: 12
#| fig-height: 5

# Pass the city object directly instead of just the grid
visualize_grid(city, show=True)
```

### Population Distribution

```{python}
#| fig-width: 8
#| fig-height: 7

# Pass the city object directly instead of just the grid
visualize_population(city, show=True)
```

### Housing Units Distribution

```{python}
#| fig-width: 8
#| fig-height: 7

# Pass the city object directly instead of just the grid
visualize_units(city, show=True)
```

## Grid Statistics

```{python}
# Pass the city object directly instead of just the grid
print_grid_summary(city)
```

## Compare Different Configurations

### Clustered Centers

```{python}
#| fig-width: 12
#| fig-height: 5

config_clustered = PolycentricConfig(
    num_centers=3,
    center_distribution="clustered",
    primary_density=18.0
)

city_clustered = PolycentricCity(grid_rows=30, grid_cols=30, config=config_clustered)
grid_clustered = city_clustered.generate()

# Pass the city object directly
visualize_grid(city_clustered, show=True)
```

### Random Centers

```{python}
#| fig-width: 12
#| fig-height: 5

config_random = PolycentricConfig(
    num_centers=5,
    center_distribution="random",
    primary_density=18.0,
    min_center_separation_blocks=8
)

city_random = PolycentricCity(grid_rows=30, grid_cols=30, config=config_random)
grid_random = city_random.generate()

# Pass the city object directly
visualize_grid(city_random, show=True)
```

## Cities with Transportation Corridors

Transportation corridors can significantly affect density patterns by providing higher accessibility along major routes.

### Inter-Center Corridors

Connect all activity centers with transportation corridors:

```{python}
#| fig-width: 15
#| fig-height: 5

# Configure city with transportation
config_transport = PolycentricConfig(
    num_centers=4,
    center_distribution="uniform",
    primary_density=18.0,
    density_decay_rate=0.15
)

transport_config = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.20,  # 20% density boost along corridors
    connect_all_centers=True
)

# Generate city with corridors
city_transport = PolycentricCity(
    grid_rows=60,
    grid_cols=60,
    config=config_transport,
    transport_configs=[transport_config]
)
grid_transport = city_transport.generate()

# Show summary
city_transport.visualize_summary()

# Visualize with corridors highlighted - pass city object directly
visualize_with_corridors(city_transport, show=True)
```

### Radial Corridors (Hub-and-Spoke)

Create a hub-and-spoke pattern from the primary center:

```{python}
#| fig-width: 15
#| fig-height: 5

transport_config_radial = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.15,
    radial_corridors_count=6,
    include_ring_roads=True,
    ring_road_radius_blocks=15
)

city_radial = PolycentricCity(
    grid_rows=60,
    grid_cols=60,
    config=config_transport,
    transport_configs=[transport_config_radial]
)
grid_radial = city_radial.generate()

# Pass city object directly
visualize_with_corridors(city_radial, show=True)
```

### Grid Pattern (Manhattan-style)

Orthogonal grid of major transportation routes:

```{python}
#| fig-width: 15
#| fig-height: 5

transport_config_grid = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.10
)

city_grid = PolycentricCity(
    grid_rows=60,
    grid_cols=60,
    config=config_transport,
    transport_configs=[transport_config_grid]
)
grid_grid_pattern = city_grid.generate()

# Pass city object directly
visualize_with_corridors(city_grid, show=True)
```

## San Francisco Clone

```{python}
city_config = CityConfig(
    width=100,
    height=100,
    block_size_meters=100.0,
    block_area_acres=2.47,  # ~100m x 100m
    max_density_units_per_acre=100.0,
    min_density_units_per_acre=1.0,
    persons_per_unit=2.5
)

# Configure polycentric density
polycentric_config = PolycentricConfig(
    num_centers=8,
    center_distribution="uniform",
    primary_density=50,
    density_decay_rate=0.2
)

main_roads = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=3,
    density_multiplier=1.3,
    connect_all_centers=True
)

# 2. Narrow transit grid
transit_grid = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.1
)

# 3. Radial corridors from center
radial = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.2,
    radial_corridors_count=6
)

# Create city with all three corridor types
city_sf_like = City(
    config=city_config,
    polycentric_config=polycentric_config,
    transport_configs=[main_roads, transit_grid, radial]
)
grid = city_sf_like.generate()

# Pass city object directly
visualize_with_corridors(city_sf_like, show=True)
```
