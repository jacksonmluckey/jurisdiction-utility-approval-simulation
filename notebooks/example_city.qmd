---
title: "Polycentric City Visualization Example"
format:
    html:
        embed-resources: true

---

This notebook demonstrates how to generate and visualize polycentric city density patterns using the City class.

## Setup

```{python}
import sys
sys.path.append('..')

from city import City, CityConfig
from city import CityCentersConfig, TransportationConfig, CorridorType
```

## City Class Examples

The `City` class provides a unified interface for creating cities with all configuration in one place. Here are several examples demonstrating different city types.

### Example 1: Basic City with Polycentric Density

```{python}
print("=" * 70)
print("EXAMPLE 1: Basic City with Polycentric Density")
print("=" * 70)

# Configure city parameters
city_config = CityConfig(
    width=50,
    height=50,
    block_size_meters=100.0,
    max_density_units_per_km2=125000.0,
    min_density_units_per_km2=250.0,
    persons_per_unit=2.5
)

# Configure polycentric density
centers_config = CityCentersConfig(
    num_centers=3,
    center_distribution="uniform",
    primary_density_km2=2500.0,
    density_decay_rate=0.15
)

# Create and generate city
city = City(
    config=city_config,
    centers_config=centers_config
)
grid = city.generate()

# Show summary
city.summary()

# Access properties
print(f"\nCity Properties:")
print(f"  Total population: {city.total_population:,.0f}")
print(f"  Total units: {city.total_units:,}")
print(f"  Total area: {city.total_area_km2:,.1f} km²")
print(f"  Average density: {city.average_density:.2f} units/km²")
```

### Example 2: City with Transportation Corridors

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 2: City with Transportation Corridors")
print("=" * 70)

# Configure transportation
transport_config = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.20,
    connect_all_centers=True
)

# Create city with transportation
city_with_transport = City(
    config=city_config,
    centers_config=centers_config,
    transport_configs=[transport_config]
)
grid_transport = city_with_transport.generate()

city_with_transport.summary()
```

### Example 3: High-Density City with Radial Corridors

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 3: High-Density City with Radial Corridors")
print("=" * 70)

# High-density configuration
high_density_config = CityConfig(
    width=40,
    height=40,
    max_density_units_per_km2=20000.0,
    persons_per_unit=2.2  # Smaller household size in high-density areas
)

# More centers, higher density
high_density_polycentric = CityCentersConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density_km2=35.0,
    density_decay_rate=0.10
)

# Radial corridors
radial_transport = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.25,
    radial_corridors_count=6,
    include_ring_roads=True,
    ring_road_radius_blocks=10
)

city_high_density = City(
    config=high_density_config,
    centers_config=high_density_polycentric,
    transport_configs=[radial_transport]
)
city_high_density.generate()
city_high_density.summary()
```

### Example 4: City with Multiple Transportation Corridors

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 4: City with Multiple Transportation Corridors")
print("=" * 70)

# Configure multiple transportation corridor types
# 1. Wide highways connecting centers
highways = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=3,
    density_multiplier=1.10,
    connect_all_centers=True
)

# 2. Narrow transit grid
transit_grid = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.25
)

# 3. Radial corridors from center
radial = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.15,
    radial_corridors_count=6
)

# Create city with all three corridor types
city_multi = City(
    config=city_config,
    centers_config=centers_config,
    transport_configs=[highways, transit_grid, radial]
)
city_multi.generate()
city_multi.summary()

print("\n" + "=" * 70)
print("All examples completed successfully!")
print("=" * 70)
```

### Example 5: City with Density Noise

Add realistic variability to housing units using proportional noise:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 5: City with Density Noise")
print("=" * 70)

import numpy as np

# Configure city with proportional noise
# units_noise=0.15 means 15% std dev relative to base units
city_config_noise = CityConfig(
    width=50,
    height=50,
    max_density_units_per_km2=12500.0,
    persons_per_unit=2.5,
    units_noise=0.15,  # 15% proportional noise
    random_seed=42  # For reproducibility
)

centers_config = CityCentersConfig(
    num_centers=3,
    center_distribution="uniform",
    primary_density_km2=25.0,
    density_decay_rate=0.15
)

city_noise = City(
    config=city_config_noise,
    centers_config=centers_config
)
city_noise.generate()
city_noise.summary()

# Show some example blocks to see variation
print("\nSample blocks showing noise effect:")
sample_blocks = [city_noise.grid.blocks[i] for i in [100, 500, 1000, 1500, 2000]]
for block in sample_blocks:
    print(f"  Block ({block.x}, {block.y}): {block.units} units, {block.population:.1f} people")

# Visualize to see spatial noise pattern
city_noise.visualize()
```

### Example 6: City with Custom Noise Function

Use a custom function to control noise based on density:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 6: City with Custom Noise Function")
print("=" * 70)

def heteroskedastic_noise(base_units):
    """
    Higher absolute variability in denser areas, but lower relative variability.
    Sparse areas: high relative variability (±50%)
    Dense areas: low relative variability (±10%)
    """
    if base_units < 20:
        # Sparse: high proportional noise
        std_dev = base_units * 0.5
    elif base_units < 50:
        # Medium density: moderate noise
        std_dev = base_units * 0.25
    else:
        # High density: lower proportional noise but higher absolute
        std_dev = base_units * 0.1

    return np.random.normal(0, std_dev)

city_config_custom_noise = CityConfig(
    width=50,
    height=50,
    max_density_units_per_km2=15000.0,
    persons_per_unit=2.5,
    units_noise=heteroskedastic_noise,
    random_seed=42
)

city_custom_noise = City(
    config=city_config_custom_noise,
    centers_config=centers_config
)
city_custom_noise.generate()
city_custom_noise.summary()

# Visualize heteroskedastic noise pattern
city_custom_noise.visualize()
```

### Example 7: City with Dynamic Household Size

Use a function to vary household size based on housing density:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 7: City with Dynamic Household Size")
print("=" * 70)

def density_based_household_size(units, noise):
    """
    Household size decreases with higher density:
    - Sparse areas (< 20 units): Suburban families, avg 3.0 persons
    - Medium areas (20-50 units): Mixed housing, avg 2.3 persons
    - Dense areas (> 50 units): Apartments, avg 1.8 persons
    """
    if units < 20:
        return 3.0  # Suburban single-family homes
    elif units < 50:
        return 2.3  # Urban mixed housing
    else:
        return 1.8  # High-density apartments

city_config_dynamic = CityConfig(
    width=50,
    height=50,
    max_density_units_per_km2=20000.0,
    persons_per_unit=density_based_household_size,  # Function instead of float
    random_seed=42
)

polycentric_dense = CityCentersConfig(
    num_centers=4,
    center_distribution="uniform",
    primary_density_km2=35.0,
    density_decay_rate=0.12
)

city_dynamic = City(
    config=city_config_dynamic,
    centers_config=polycentric_dense
)
city_dynamic.generate()
city_dynamic.summary()

# Show how household size varies with density
print("\nHousehold size variation by density:")
low_density_blocks = [b for b in city_dynamic.grid.blocks if b.units < 20]
med_density_blocks = [b for b in city_dynamic.grid.blocks if 20 <= b.units < 50]
high_density_blocks = [b for b in city_dynamic.grid.blocks if b.units >= 50]

if low_density_blocks:
    avg_household_low = np.mean([b.population / b.units for b in low_density_blocks if b.units > 0])
    print(f"  Low density (< 20 units): {avg_household_low:.2f} persons/unit")
if med_density_blocks:
    avg_household_med = np.mean([b.population / b.units for b in med_density_blocks if b.units > 0])
    print(f"  Medium density (20-50 units): {avg_household_med:.2f} persons/unit")
if high_density_blocks:
    avg_household_high = np.mean([b.population / b.units for b in high_density_blocks if b.units > 0])
    print(f"  High density (> 50 units): {avg_household_high:.2f} persons/unit")

# Visualize the city with variable household sizes
city_dynamic.visualize()
```

### Example 8: Combining Noise and Dynamic Household Size

Combine both features for maximum realism:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 8: Combining Noise and Dynamic Household Size")
print("=" * 70)

def adaptive_household_size(units, noise):
    """
    Household size based on density, with noise awareness.
    In high-variability blocks, household composition may be more diverse.
    """
    # Base household size by density
    if units < 25:
        base_size = 2.8
    elif units < 60:
        base_size = 2.2
    else:
        base_size = 1.9

    # Adjust slightly for high-variance blocks (more mixed housing types)
    if noise is not None and abs(noise) > 15:
        base_size += 0.1  # Slightly higher diversity in high-variance blocks

    return base_size

city_config_combined = CityConfig(
    width=60,
    height=60,
    max_density_units_per_km2=17500.0,
    units_noise=0.12,  # 12% proportional noise
    persons_per_unit=adaptive_household_size,
    random_seed=42
)

polycentric_realistic = CityCentersConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density_km2=30.0,
    density_decay_rate=0.10
)

# Add transportation for added realism
transit_corridors = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.18
)

city_combined = City(
    config=city_config_combined,
    centers_config=polycentric_realistic,
    transport_configs=[transit_corridors]
)
city_combined.generate()
city_combined.summary()

# Analyze the combined effect
print("\nCombined effects analysis:")
print(f"  Population range: {min(b.population for b in city_combined.grid.blocks):.0f} - "
      f"{max(b.population for b in city_combined.grid.blocks):.0f} people/block")
print(f"  Units range: {min(b.units for b in city_combined.grid.blocks)} - "
      f"{max(b.units for b in city_combined.grid.blocks)} units/block")

# Calculate coefficient of variation for units (shows noise effect)
units_list = [b.units for b in city_combined.grid.blocks]
cv_units = np.std(units_list) / np.mean(units_list)
print(f"  Coefficient of variation (units): {cv_units:.3f}")

# Visualize the complete realistic city
city_combined.visualize()
```

### Example 9: City with Parks

Add parks to provide green space throughout the city:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 9: City with Parks")
print("=" * 70)

from city import ParkConfig

# Configure parks
park_config = ParkConfig(
    num_parks=8,
    min_size_blocks=2,
    max_size_blocks=8,
    placement_strategy="dispersed",  # Spread parks evenly
    shape="square"
)

city_config_parks = CityConfig(
    width=50,
    height=50,
    max_density_units_per_km2=15000.0,
    persons_per_unit=2.5,
    random_seed=42
)

polycentric_parks = CityCentersConfig(
    num_centers=3,
    center_distribution="uniform",
    primary_density_km2=28.0,
    density_decay_rate=0.15
)

city_parks = City(
    config=city_config_parks,
    centers_config=polycentric_parks,
    park_config=park_config
)
city_parks.generate()
city_parks.summary()

# Visualize - parks will appear as green overlays
city_parks.visualize()
```

### Example 10: City with Parks, Transportation, and Variable Density

Combine all features for a fully realistic city simulation:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 10: Complete City with Parks, Transit, and Variability")
print("=" * 70)

# Full city configuration
full_city_config = CityConfig(
    width=60,
    height=60,
    max_density_units_per_km2=20000.0,
    units_noise=0.10,  # 10% variability
    persons_per_unit=lambda units, noise: 2.8 if units < 30 else 2.0,
    random_seed=42
)

# Multiple activity centers
full_polycentric = CityCentersConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density_km2=35.0,
    density_decay_rate=0.12
)

# Transit corridors
transit = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.15
)

# Parks spread throughout
full_parks = ParkConfig(
    num_parks=12,
    min_size_blocks=3,
    max_size_blocks=12,
    placement_strategy="dispersed",
    shape="square"
)

# Create the complete city
full_city = City(
    config=full_city_config,
    centers_config=full_polycentric,
    transport_configs=[transit],
    park_config=full_parks
)
full_city.generate()
full_city.summary()

# Visualize the complete city
# Parks appear as green spaces, overlaid on density maps
full_city.visualize()

print("\nNote: Parks (green) provide zero-density areas dispersed throughout the city.")
```

### Example 11: City with Zoning

Add zoning regulations that control land use and density:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 11: City with Zoning")
print("=" * 70)

from city import ZoningConfig

# Configure zoning
zoning_config = ZoningConfig(
    enabled=True,
    low_density_threshold=30,
    medium_density_threshold=60,
    center_radius_blocks=3  # Radius around centers for mixed-use high density
)

city_config_zoning = CityConfig(
    width=40,
    height=40,
    max_density_units_per_km2=17500.0,
    persons_per_unit=2.5,
    random_seed=42
)

polycentric_zoning = CityCentersConfig(
    num_centers=3,
    center_distribution="clustered",
    primary_density_km2=32.0,
    density_decay_rate=0.13,
    min_center_separation_blocks=15,
)

city_zoning = City(
    config=city_config_zoning,
    centers_config=polycentric_zoning,
    zoning_config=zoning_config
)
city_zoning.generate()
city_zoning.summary()

# Visualize zoning map
city_zoning.visualize_zoning()
```

### Example 12: Complete City with All Features

Combine zoning, parks, transportation, noise, and variable density:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 12: Complete Realistic City with All Features")
print("=" * 70)

# Full feature city
complete_config = CityConfig(
    width=200,
    height=200,
    max_density_units_per_km2=50000.0,
    units_noise=0.12,
    persons_per_unit=lambda units, noise: 2.8 if units < 35 else 2.0,
    random_seed=42
)

complete_polycentric = CityCentersConfig(
    num_centers=6,
    center_distribution="clustered",
    primary_density_km2=40000.0,
    density_decay_rate=0.11,
    min_center_separation_blocks=15
)

inter_city_transit = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.18
)

grid_transit = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.05
)

complete_parks = ParkConfig(
    num_parks=20,
    min_size_blocks=3,
    max_size_blocks=25,
    placement_strategy="dispersed"
)

complete_zoning = ZoningConfig(
    enabled=True,
    low_density_threshold=25,
    medium_density_threshold=55,
    center_radius_blocks=3
)

complete_city = City(
    config=complete_config,
    centers_config=complete_polycentric,
    transport_configs=[inter_city_transit, grid_transit],
    park_config=complete_parks,
    zoning_config=complete_zoning
)
complete_city.generate()
complete_city.summary()

print("\nVisualizing density and land use:")
complete_city.visualize()

print("\nVisualizing zoning regulations:")
complete_city.visualize_zoning()
```

---

## Alternative: Using Individual Components

You can also use `CityCenters` directly for more granular control:

### Setup (Alternative)

```{python}
from city import CityCenters, CityCentersConfig
from city import visualize_grid, visualize_population, visualize_units, print_grid_summary
from city import visualize_with_corridors
```

## Generate a Polycentric City

Create a city with 3 centers distributed uniformly:

```{python}
# Configure the city
config = CityCentersConfig(
    num_centers=5,
    center_distribution="uniform",
    primary_density_km2=18.0,
    density_decay_rate=0.1,
    center_strength_decay=0.6,
    persons_per_unit=2.5
)

# Generate the city
city = CityCenters(grid_rows=100, grid_cols=100, config=config)
grid = city.generate()

# Show summary
city.visualize_summary()
```

## Visualize the City

### Combined View (Population + Units)

```{python}
#| fig-width: 12
#| fig-height: 5

# Pass the city object directly instead of just the grid
visualize_grid(city, show=True)
```

### Population Distribution

```{python}
#| fig-width: 8
#| fig-height: 7

# Pass the city object directly instead of just the grid
visualize_population(city, show=True)
```

### Housing Units Distribution

```{python}
#| fig-width: 8
#| fig-height: 7

# Pass the city object directly instead of just the grid
visualize_units(city, show=True)
```

## Grid Statistics

```{python}
# Pass the city object directly instead of just the grid
print_grid_summary(city)
```

## Compare Different Configurations

### Clustered Centers

```{python}
#| fig-width: 12
#| fig-height: 5

config_clustered = CityCentersConfig(
    num_centers=3,
    center_distribution="clustered",
    primary_density_km2=18.0
)

city_clustered = CityCenters(grid_rows=30, grid_cols=30, config=config_clustered)
grid_clustered = city_clustered.generate()

# Pass the city object directly
visualize_grid(city_clustered, show=True)
```

### Random Centers

```{python}
#| fig-width: 12
#| fig-height: 5

config_random = CityCentersConfig(
    num_centers=5,
    center_distribution="random",
    primary_density_km2=18.0,
    min_center_separation_blocks=8
)

city_random = CityCenters(grid_rows=30, grid_cols=30, config=config_random)
grid_random = city_random.generate()

# Pass the city object directly
visualize_grid(city_random, show=True)
```

## Cities with Transportation Corridors

Transportation corridors can significantly affect density patterns by providing higher accessibility along major routes.

### Inter-Center Corridors

Connect all activity centers with transportation corridors:

```{python}
#| fig-width: 15
#| fig-height: 5

# Configure city with transportation
config_transport = CityCentersConfig(
    num_centers=4,
    center_distribution="uniform",
    primary_density_km2=18.0,
    density_decay_rate=0.15
)

transport_config = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=2,
    density_multiplier=1.20,  # 20% density boost along corridors
    connect_all_centers=True
)

# Generate city with corridors
city_transport = CityCenters(
    grid_rows=60,
    grid_cols=60,
    config=config_transport,
    transport_configs=[transport_config]
)
grid_transport = city_transport.generate()

# Show summary
city_transport.visualize_summary()

# Visualize with corridors highlighted - pass city object directly
visualize_with_corridors(city_transport, show=True)
```

### Radial Corridors (Hub-and-Spoke)

Create a hub-and-spoke pattern from the primary center:

```{python}
#| fig-width: 15
#| fig-height: 5

transport_config_radial = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.15,
    radial_corridors_count=6,
    include_ring_roads=True,
    ring_road_radius_blocks=15
)

city_radial = CityCenters(
    grid_rows=60,
    grid_cols=60,
    config=config_transport,
    transport_configs=[transport_config_radial]
)
grid_radial = city_radial.generate()

# Pass city object directly
visualize_with_corridors(city_radial, show=True)
```

### Grid Pattern (Manhattan-style)

Orthogonal grid of major transportation routes:

```{python}
#| fig-width: 15
#| fig-height: 5

transport_config_grid = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.10
)

city_grid = CityCenters(
    grid_rows=60,
    grid_cols=60,
    config=config_transport,
    transport_configs=[transport_config_grid]
)
grid_grid_pattern = city_grid.generate()

# Pass city object directly
visualize_with_corridors(city_grid, show=True)
```

## San Francisco Clone

```{python}
city_config = CityConfig(
    width=100,
    height=100,
    block_size_meters=100.0,
    max_density_units_per_km2=25000.0,
    min_density_units_per_km2=250.0,
    persons_per_unit=2.5
)

# Configure polycentric density
centers_config = CityCentersConfig(
    num_centers=8,
    center_distribution="uniform",
    primary_density_km2=50,
    density_decay_rate=0.2
)

main_roads = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=3,
    density_multiplier=1.3,
    connect_all_centers=True
)

# 2. Narrow transit grid
transit_grid = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.1
)

# 3. Radial corridors from center
radial = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.2,
    radial_corridors_count=6
)

# Create city with all three corridor types
city_sf_like = City(
    config=city_config,
    centers_config=centers_config,
    transport_configs=[main_roads, transit_grid, radial]
)
grid = city_sf_like.generate()

# Pass city object directly
visualize_with_corridors(city_sf_like, show=True)
```

## Commercial Development: Offices and Shops

The city simulation now includes office and shop/retail units that follow realistic spatial patterns.

### Example 13: Basic City with Commercial Development

Offices and shops are automatically generated based on zoning and location:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 13: City with Offices and Shops")
print("=" * 70)

# Configure city with commercial parameters
commercial_config = CityConfig(
    width=50,
    height=50,
    max_density_units_per_km2=15000.0,
    persons_per_unit=2.5,
    # Commercial density parameters
    max_density_offices_per_km2=7500.0,
    max_density_shops_per_km2=5000.0,
    office_center_concentration=0.15,  # Offices concentrated at centers
    shop_center_concentration=0.10,    # Shops less concentrated
    shop_corridor_multiplier=1.3,      # 30% boost for shops on corridors
    random_seed=42
)

polycentric_commercial = CityCentersConfig(
    num_centers=3,
    center_distribution="uniform",
    primary_density_km2=30.0,
    density_decay_rate=0.15
)

# Add zoning to enable commercial uses
zoning_commercial = ZoningConfig(
    enabled=True,
    center_radius_blocks=4  # Larger commercial zones at centers
)

city_commercial = City(
    config=commercial_config,
    centers_config=polycentric_commercial,
    zoning_config=zoning_commercial
)
city_commercial.generate()
city_commercial.summary()

# Show some example blocks
print("\nSample blocks showing commercial development:")
sample_indices = [1200, 1225, 1250, 1275, 1300]
for idx in sample_indices:
    block = city_commercial.grid.blocks[idx]
    print(f"  Block ({block.x}, {block.y}): {block.units} units, "
          f"{block.offices} offices, {block.shops} shops")
```

### Example 14: Commercial Concentration at Centers vs Corridors

Compare office and shop distributions to see how they differ:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 14: Commercial Development with Transportation Corridors")
print("=" * 70)

# City with transit corridors to see shop concentration
corridor_city_config = CityConfig(
    width=60,
    height=60,
    max_density_units_per_km2=17500.0,
    persons_per_unit=2.5,
    max_density_offices_per_km2=10000.0,    # Higher office density
    max_density_shops_per_km2=6250.0,      # Higher shop density
    office_center_concentration=0.20,     # Very concentrated offices
    shop_center_concentration=0.08,       # More dispersed shops
    shop_corridor_multiplier=1.5,         # 50% boost on corridors
    random_seed=42
)

polycentric_corridor = CityCentersConfig(
    num_centers=4,
    center_distribution="uniform",
    primary_density_km2=35.0,
    density_decay_rate=0.12
)

# Grid transit to create many corridors
grid_transit = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.15,
    grid_spacing_blocks=8  # Frequent grid
)

zoning_corridor = ZoningConfig(
    enabled=True,
    center_radius_blocks=5
)

city_corridor = City(
    config=corridor_city_config,
    centers_config=polycentric_corridor,
    transport_configs=[grid_transit],
    zoning_config=zoning_corridor
)
city_corridor.generate()
city_corridor.summary()

# Analyze office vs shop patterns
print("\nAnalyzing commercial patterns:")

# Find center blocks (high offices)
center_blocks = sorted(city_corridor.grid.blocks, key=lambda b: b.offices, reverse=True)[:50]
avg_center_offices = np.mean([b.offices for b in center_blocks])
avg_center_shops = np.mean([b.shops for b in center_blocks])

print(f"  Top 50 office blocks (centers):")
print(f"    Avg offices: {avg_center_offices:.1f}")
print(f"    Avg shops: {avg_center_shops:.1f}")

# Find corridor blocks (not in top centers, but on corridors)
non_center_blocks = [b for b in city_corridor.grid.blocks
                     if b not in center_blocks
                     and city_corridor.transport_network.is_on_corridor(b.y, b.x)
                     and b.shops > 0]

if non_center_blocks:
    avg_corridor_offices = np.mean([b.offices for b in non_center_blocks])
    avg_corridor_shops = np.mean([b.shops for b in non_center_blocks])
    print(f"\n  Corridor blocks (not centers):")
    print(f"    Avg offices: {avg_corridor_offices:.1f}")
    print(f"    Avg shops: {avg_corridor_shops:.1f}")
    print(f"  Shops benefit {avg_corridor_shops/avg_corridor_offices:.2f}x more from corridors than offices")

# Visualize the city
city_corridor.visualize()
```

### Example 15: Configurable Commercial Density

Explore different commercial development patterns:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 15: High Commercial Density Downtown Core")
print("=" * 70)

# Create a city with very concentrated downtown commercial
downtown_config = CityConfig(
    width=40,
    height=40,
    max_density_units_per_km2=25000.0,
    persons_per_unit=2.0,
    # Very high commercial density
    max_density_offices_per_km2=20000.0,     # CBD-level offices
    max_density_shops_per_km2=12500.0,       # High retail
    office_center_concentration=0.25,      # Very concentrated
    shop_center_concentration=0.15,        # Moderately concentrated
    shop_corridor_multiplier=1.4,
    random_seed=42
)

# Single strong center (CBD)
downtown_polycentric = CityCentersConfig(
    num_centers=1,  # Single downtown
    center_distribution="uniform",
    primary_density_km2=60.0,
    density_decay_rate=0.18
)

# Radial transit from downtown
downtown_transit = TransportationConfig(
    corridor_type=CorridorType.RADIAL,
    corridor_width_blocks=2,
    density_multiplier=1.20,
    radial_corridors_count=8,
    include_ring_roads=True,
    ring_road_radius_blocks=10
)

downtown_zoning = ZoningConfig(
    enabled=True,
    center_radius_blocks=6,  # Large CBD core
    low_density_threshold=40,
    medium_density_threshold=80
)

city_downtown = City(
    config=downtown_config,
    centers_config=downtown_polycentric,
    transport_configs=[downtown_transit],
    zoning_config=downtown_zoning
)
city_downtown.generate()
city_downtown.summary()

# Find the CBD core
center_pos = city_downtown.centers[0]['position']
center_y, center_x = center_pos

print(f"\nCBD Core (within 3 blocks of center at {center_pos}):")
cbd_blocks = [b for b in city_downtown.grid.blocks
              if np.sqrt((b.x - center_x)**2 + (b.y - center_y)**2) <= 3]

total_cbd_offices = sum(b.offices for b in cbd_blocks)
total_cbd_shops = sum(b.shops for b in cbd_blocks)
total_cbd_units = sum(b.units for b in cbd_blocks)

print(f"  Total offices: {total_cbd_offices:,}")
print(f"  Total shops: {total_cbd_shops:,}")
print(f"  Total housing: {total_cbd_units:,}")
print(f"  Office density: {total_cbd_offices/len(cbd_blocks):.1f} per block")
print(f"  Shop density: {total_cbd_shops/len(cbd_blocks):.1f} per block")

city_downtown.visualize()
```

### Example 16: Multi-Center Commercial Hierarchy

Create a realistic multi-center city with commercial hierarchy:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 16: Multi-Center City with Commercial Hierarchy")
print("=" * 70)

# Large city with multiple commercial nodes
metro_config = CityConfig(
    width=80,
    height=80,
    max_density_units_per_km2=22500.0,
    persons_per_unit=2.3,
    max_density_offices_per_km2=12500.0,
    max_density_shops_per_km2=7500.0,
    office_center_concentration=0.18,
    shop_center_concentration=0.10,
    shop_corridor_multiplier=1.35,
    units_noise=0.10,
    random_seed=42
)

# Multiple commercial centers
metro_polycentric = CityCentersConfig(
    num_centers=6,
    center_distribution="uniform",
    primary_density_km2=45.0,
    density_decay_rate=0.14,
    center_strength_decay=0.65
)

# Inter-center highways
highways = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=3,
    density_multiplier=1.15,
    connect_all_centers=True
)

# Local grid
local_streets = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.08,
    grid_spacing_blocks=10
)

metro_zoning = ZoningConfig(
    enabled=True,
    center_radius_blocks=4,
    low_density_threshold=35,
    medium_density_threshold=70
)

city_metro = City(
    config=metro_config,
    centers_config=metro_polycentric,
    transport_configs=[highways, local_streets],
    zoning_config=metro_zoning
)
city_metro.generate()
city_metro.summary()

# Analyze each commercial center
print("\nCommercial center analysis:")
for i, center in enumerate(city_metro.centers):
    center_y, center_x = center['position']

    # Get blocks within radius
    nearby = [b for b in city_metro.grid.blocks
              if np.sqrt((b.x - center_x)**2 + (b.y - center_y)**2) <= 5]

    if nearby:
        total_offices = sum(b.offices for b in nearby)
        total_shops = sum(b.shops for b in nearby)
        avg_offices = total_offices / len(nearby)
        avg_shops = total_shops / len(nearby)

        print(f"\n  Center {i+1} at {center['position']} (strength {center['strength']:.2f}):")
        print(f"    Total offices: {total_offices:,}")
        print(f"    Total shops: {total_shops:,}")
        print(f"    Avg offices/block: {avg_offices:.1f}")
        print(f"    Avg shops/block: {avg_shops:.1f}")

city_metro.visualize()
```

### Example 17: Complete City with All Features Including Commercial

Final comprehensive example with everything:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 17: Complete Realistic City with Commercial Development")
print("=" * 70)

complete_commercial_config = CityConfig(
    width=100,
    height=100,
    max_density_units_per_km2=30000.0,
    min_density_units_per_km2=500.0,
    persons_per_unit=lambda u, n: 2.9 if u < 30 else 2.1,
    units_noise=0.12,
    # Commercial parameters
    max_density_offices_per_km2=62500.0,
    max_density_shops_per_km2=8750.0,
    office_center_concentration=0.16,
    shop_center_concentration=0.09,
    shop_corridor_multiplier=1.4,
    random_seed=42
)

complete_polycentric = CityCentersConfig(
    num_centers=7,
    center_distribution="clustered",
    primary_density_km2=55.0,
    density_decay_rate=0.12,
    center_strength_decay=0.7
)

major_roads = TransportationConfig(
    corridor_type=CorridorType.INTER_CENTER,
    corridor_width_blocks=3,
    density_multiplier=1.18,
    connect_all_centers=True
)

arterials = TransportationConfig(
    corridor_type=CorridorType.GRID,
    corridor_width_blocks=1,
    density_multiplier=1.10,
    grid_spacing_blocks=12
)

complete_parks = ParkConfig(
    num_parks=15,
    min_size_blocks=4,
    max_size_blocks=16,
    placement_strategy="dispersed",
    shape="square"
)

complete_zoning = ZoningConfig(
    enabled=True,
    center_radius_blocks=5,
    low_density_threshold=30,
    medium_density_threshold=65
)

complete_city_final = City(
    config=complete_commercial_config,
    centers_config=complete_polycentric,
    transport_configs=[major_roads, arterials],
    park_config=complete_parks,
    zoning_config=complete_zoning
)
complete_city_final.generate()
complete_city_final.summary()

# Comprehensive analysis
print("\nComprehensive City Analysis:")
print(f"  Population: {complete_city_final.total_population:,.0f}")
print(f"  Housing units: {complete_city_final.total_units:,}")
print(f"  Office units: {sum(b.offices for b in complete_city_final.grid.blocks):,}")
print(f"  Retail units: {sum(b.shops for b in complete_city_final.grid.blocks):,}")
print(f"  Jobs (assuming 1 office = 1 job): {sum(b.offices for b in complete_city_final.grid.blocks):,}")

# Calculate jobs-housing balance
total_jobs = sum(b.offices + b.shops for b in complete_city_final.grid.blocks)
jobs_housing_ratio = total_jobs / complete_city_final.total_population if complete_city_final.total_population > 0 else 0
print(f"  Jobs per resident: {jobs_housing_ratio:.3f}")

# Visualize
complete_city_final.visualize()
complete_city_final.visualize_zoning()
```

### Example 18: Automatic Upzoning

Demonstrate the automatic upzoning feature that spreads high-density and commercial zoning from activity centers:

```{python}
print("\n" + "=" * 70)
print("EXAMPLE 18: Automatic Upzoning Comparison")
print("=" * 70)

from city import Density, Use

# Basic city configuration for upzoning comparison
upzone_config = CityConfig(
    width=30,
    height=30,
    block_size_meters=100.0,
    max_density_units_per_km2=1235.0,
    random_seed=42
)

upzone_polycentric = CityCentersConfig(
    num_centers=2,
    primary_density_km2=618.0
)

# City WITHOUT automatic upzoning
print("\n" + "=" * 70)
print("WITHOUT AUTOMATIC UPZONING")
print("=" * 70)

zoning_no_upzone = ZoningConfig(
    enabled=True,
    auto_upzone_enabled=False
)

city_no_upzone = City(
    config=upzone_config,
    centers_config=upzone_polycentric,
    zoning_config=zoning_no_upzone
)
city_no_upzone.generate()

# Count zoning distribution
high_density_no_upzone = len([
    b for b in city_no_upzone.grid.blocks
    if b.zoning and b.zoning.max_density == Density.HIGH
])
commercial_no_upzone = len([
    b for b in city_no_upzone.grid.blocks
    if b.zoning and Use.COMMERCIAL in b.zoning.allowed_uses
])
office_no_upzone = len([
    b for b in city_no_upzone.grid.blocks
    if b.zoning and Use.OFFICE in b.zoning.allowed_uses
])

print(f"\nHigh-density blocks: {high_density_no_upzone}")
print(f"Commercial-allowed blocks: {commercial_no_upzone}")
print(f"Office-allowed blocks: {office_no_upzone}")

# Visualize zoning without upzoning
city_no_upzone.visualize_zoning()

# City WITH automatic upzoning (moderate settings)
print("\n" + "=" * 70)
print("WITH AUTOMATIC UPZONING (MODERATE)")
print("=" * 70)

zoning_moderate = ZoningConfig(
    enabled=True,
    auto_upzone_enabled=True,
    auto_upzone_density_threshold=3,      # Need 3 higher-density neighbors
    auto_upzone_use_threshold=3,          # Need 3 neighbors with use
    auto_upzone_include_diagonals=True,   # Count all 8 neighbors
    auto_upzone_iterations=2              # Two passes
)

city_moderate = City(
    config=upzone_config,
    centers_config=upzone_polycentric,
    zoning_config=zoning_moderate
)
city_moderate.generate()

high_density_moderate = len([
    b for b in city_moderate.grid.blocks
    if b.zoning and b.zoning.max_density == Density.HIGH
])
commercial_moderate = len([
    b for b in city_moderate.grid.blocks
    if b.zoning and Use.COMMERCIAL in b.zoning.allowed_uses
])
office_moderate = len([
    b for b in city_moderate.grid.blocks
    if b.zoning and Use.OFFICE in b.zoning.allowed_uses
])

print(f"\nHigh-density blocks: {high_density_moderate}")
print(f"Commercial-allowed blocks: {commercial_moderate}")
print(f"Office-allowed blocks: {office_moderate}")

# Visualize zoning with moderate upzoning
city_moderate.visualize_zoning()

# City WITH aggressive automatic upzoning
print("\n" + "=" * 70)
print("WITH AUTOMATIC UPZONING (AGGRESSIVE)")
print("=" * 70)

zoning_aggressive = ZoningConfig(
    enabled=True,
    auto_upzone_enabled=True,
    auto_upzone_density_threshold=2,      # Only need 2 neighbors
    auto_upzone_use_threshold=2,
    auto_upzone_include_diagonals=False,  # Only cardinal neighbors (4 total)
    auto_upzone_iterations=5              # Many passes for wide spread
)

city_aggressive = City(
    config=upzone_config,
    centers_config=upzone_polycentric,
    zoning_config=zoning_aggressive
)
city_aggressive.generate()

high_density_aggressive = len([
    b for b in city_aggressive.grid.blocks
    if b.zoning and b.zoning.max_density == Density.HIGH
])
commercial_aggressive = len([
    b for b in city_aggressive.grid.blocks
    if b.zoning and Use.COMMERCIAL in b.zoning.allowed_uses
])
office_aggressive = len([
    b for b in city_aggressive.grid.blocks
    if b.zoning and Use.OFFICE in b.zoning.allowed_uses
])

print(f"\nHigh-density blocks: {high_density_aggressive}")
print(f"Commercial-allowed blocks: {commercial_aggressive}")
print(f"Office-allowed blocks: {office_aggressive}")

# Visualize zoning with aggressive upzoning
city_aggressive.visualize_zoning()

# Summary comparison
print("\n" + "=" * 70)
print("UPZONING COMPARISON SUMMARY")
print("=" * 70)
print(f"{'Metric':<30} {'No Upzone':<15} {'Moderate':<15} {'Aggressive':<15}")
print("-" * 75)
print(f"{'High-density blocks':<30} {high_density_no_upzone:<15} {high_density_moderate:<15} {high_density_aggressive:<15}")
print(f"{'Commercial blocks':<30} {commercial_no_upzone:<15} {commercial_moderate:<15} {commercial_aggressive:<15}")
print(f"{'Office blocks':<30} {office_no_upzone:<15} {office_moderate:<15} {office_aggressive:<15}")

print("\nKey insights:")
print("- Automatic upzoning spreads high-density zoning from activity centers")
print("- More iterations allow upzoning to propagate further")
print("- Lower thresholds create more aggressive upzoning")
print("- Including diagonals (8 neighbors) vs cardinal only (4 neighbors) affects patterns")
print("- Creates gradual density transitions instead of abrupt zoning changes")
```

